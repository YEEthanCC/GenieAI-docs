# 迭代
## 定義
對數組執行多次步驟直至輸出所有結果。

迭代步驟在清單中的每個條目（item）上執行相同的步驟。使用迭代的條件是確保輸入值已格式化為清單物件。迭代節點允許AI 工作流程處理更複雜的處理邏輯，迭代節點是循環節點的友善版本，它在自訂程度上做出了一些妥協，以便非技術使用者能夠快速入門。
## 場景
**範例1：長文章迭代生成器**

![長故事生成器](/工作流程/節點說明/images/長故事生成器.png)

1. 在**開始節點**內輸入故事標題和大綱
2. 使用**程式碼節點**從使用者輸入中提取出完整內容
3. 使用**參數擷取節點**將完整內容轉換成陣列格式
4. 透過**迭代節點**包裹的**LLM 節點**循環多次產生各章節內容
5. 將**直接回覆**節點加入在迭代節點內部，實現在每輪迭代生成之後流式輸出

**具體配置步驟**
1. 在**開始節點**配置故事標題（title）和大綱（outline）；

![開始節點配置](/工作流程/節點說明/images/開始節點配置.png)

2. 透過**Jinja-2 範本節點**將故事標題與大綱轉換為完整文字；

![模板節點](/工作流程/節點說明/images/模板節點.png)

3. 透過**參數提取節點**，將故事文字轉換成為陣列（Array）結構。提取參數為```sections```，參數類型為```Array[Object]```

![參數擷取](/工作流程/節點說明/images/參數擷取.png)

參數擷取效果受模型推理能力和指令影響，使用推理能力較強的模型，在**指令**內增加範例可以提高參數擷取的效果。

4. 將數組格式的故事大綱作為迭代節點的輸入，在迭代節點內部使用**LLM 節點**處理

![配置迭代節點](/工作流程/節點說明/images/配置迭代節點.png)

在LLM 節點內配置輸入變數```GenerateOverallOutline/output``` 和```Iteration/item```

![配置LLM節點](/工作流程/節點說明/images/配置LLM節點.png)

迭代的內建變數：```items[object]```和```index[number]```
```items[object] 代表以每輪迭代的輸入條目```;
```index[number] 代表當前迭代的輪次；```

5. 在迭代節點內部配置**直接回應節點**，可以實現在每輪迭代生成之後串流輸出。

![配置Answer節點](/工作流程/節點說明/images/配置Answer節點.png)

6. 完整調試和預覽
![按故事章節多輪迭代生成](/工作流程/節點說明/images/按故事章節多輪迭代生成.png)

**範例2：長文章迭代生成器（另一種編排方式)**

![長文章迭代生成器範例2](/工作流程/節點說明/images/長文章迭代生成器範例2.png)

- 在**開始節點**內輸入故事標題和大綱
- 使用**LLM 節點**產生文章小標題，以及小標題對應的內容
- 使用**程式碼節點**將完整內容轉換成陣列格式
- 透過**迭代節點**包裹的**LLM 節點**循環多次產生各章節內容
- 使用**模板轉換**節點將迭代節點輸出的字串陣列轉換為字串
- 在最後加入**直接回復節點**將轉換後的字串直接輸出

## 什麼是數組內容
清單是一種特定的資料類型，其中的元素以逗號分隔，以[開頭，以]結尾。例如：
**數字型：**
```[0,1,2,3,4,5]```
**字串型：**
```["monday", "Tuesday", "Wednesday", "Thursday"]```
**JSON 物件：**
```
[
    {
        "name": "Alice",
        "age": 30,
        "email": "alice@example.com"
    },
    {
        "name": "Bob",
        "age": 25,
        "email": "bob@example.com"
    },
    {
        "name": "Charlie",
        "age": 35,
        "email": "charlie@example.com"
    }
]
```
## 支援返回數組的節點
- 程式碼節點
- 參數擷取
- 知識庫檢索
- 迭代
- 工具
- HTTP 請求

## 如何取得數組格式的內容
**使用CODE 節點返回**

![code節點輸出array](/工作流程/節點說明/images/code節點輸出array.png)

**使用參數提取節點返回**

![參數擷取](/工作流程/節點說明/images/參數擷取.png)

## 如何將數組轉換為文字
迭代節點的輸出變數為數組格式，無法直接輸出。你可以使用一個簡單的步驟將數組轉換回文字。

**使用程式碼節點轉換**

![程式碼節點轉換](/工作流程/節點說明/images/程式碼節點轉換.png)
```
def main(articleSections: list):
    data = articleSections
    return {
        "result": "\n".join(data)
    }
```
**使用模板節點轉換**

![模板節點轉換](/工作流程/節點說明/images/模板節點轉換.png)

```
{{ articleSections | join("\n") }}
```

