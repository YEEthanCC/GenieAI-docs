工作流應用通常包含多個節點。如果因為某個節點的異常（例如 API 請求異常或 LLM 輸出異常）而造成整個流程的運行失敗，會迫使應用開發者不得不花費大量的精力排查故障並修覆，這在覆雜的工作流應用中尤為困難。

**異常處理機制**提供多樣化的節點錯誤處理策略，能夠在發生局部節點錯誤時拋出故障信息而不中斷主流程。你可以設置出現異常時重新執行節點，或通過備用路徑繼續任務。為關鍵節點**添加異常處理機制將極大地增強應用整體的靈活性與穩健性**。

*同時開啟錯誤重試和異常處理功能時，將優先重試運行節點。若重試後仍然失敗，再啟用異常處理機制。*


開發者無需在節點內編排覆雜的邏輯代碼或額外的節點應對錯誤情況。異常處理機制將簡化工作流的設計覆雜度，以多樣的預設策略編排工作流的執行邏輯。


[Arcade](https://app.arcade.software/share/g0ePRj5dA5WVv6noiPKX)


## 應用場景
1. 網絡異常處理

    示例：在某個工作流中需要通過三個 API 服務（例如天氣服務、新聞摘要和社交媒體分析）獲取數據並匯總。然而，其中一個服務因請求限制無法響應，導致數據獲取失敗。通過異常處理功能，主流程將繼續處理其它兩個成功的數據源，同時記錄失敗的 API 調用錯誤日志，供開發者稍後分析並優化服務調用策略。

2. 工作流備用設計

    示例：某個 LLM 節點執行生成詳細文檔摘要任務，但因輸入的篇幅過長而觸發超出 Token 限制的異常。在節點中配置異常錯誤機制後，出現此類錯誤時，可以使用備用路徑中的代碼節點協助將內容切分為多個小段並重新調用 LLM 節點，避免流程中斷。

3. 異常信息預定義

    示例：運行工作流時可能會遇到某個節點返回模糊的錯誤信息（例如簡單的“調用失敗”），難以快速定位問題。開發者可以通過異常處理機制內編寫預定義報錯信息，為後續的應用調試提供更加清晰、準確的錯誤信息。

## 異常處理機制

以下四個類型的節點新增異常處理機制，點擊標題即可閱讀詳細文檔：

- [LLM](https://docs.dify.ai/zh-hans/guides/workflow/node/llm)

- [HTTP](https://docs.dify.ai/zh-hans/guides/workflow/node/http-request)

- [代碼](https://docs.dify.ai/zh-hans/guides/workflow/node/code)

- [工具](https://docs.dify.ai/zh-hans/guides/workflow/node/tools)

## 異常重試

部分異常可以通過重新運行節點解決，此時可以在節點內開啟 **“異常重試”** 功能，設置嘗試次數與重試間隔時間。

![異常重試](/工作流/異常處理/images/異常重試.png)

如果嘗試重試運行節點後依然報錯，將按照異常處理機制中的預設策略運行接下來的流程。

異常處理

異常處理機制提供以下三種選項：

• 無：不處理異常，直接拋出節點的報錯信息並中斷整體流程。

• 默認值：允許開發者預定義異常信息。異常發生後，使用預定義的值替代原節點內置的異常輸出信息。

• 異常分支：發生異常後，執行預編排的異常分支

如需了解各個策略的說明和配置方法，請參考[預定義異常處理邏輯](https://docs.dify.ai/zh-hans/guides/workflow/error-handling/predefined-nodes-failure-logic)。

![異常處理](/工作流/異常處理/images/異常處理.png)

## 快速開始
### 場景：為工作流應用添加應對錯誤輸出代碼的處理機制
下文將以一個簡單的示例應用，演示如何在工作流應用內增設異常處理機制，以備用分支應對節點異常。
![異常處理](/工作流/異常處理/images/異常處理機制釋例.png)

**應用邏輯**： LLM 節點根據輸入的指令，生成正確或錯誤格式的 JSON 代碼內容，然後通過 A 代碼節點執行代碼並輸出結果。如果 A 代碼節點接收到了錯誤格式的 JSON 內容，則按照預設的異常處理機制，執行備用路徑而繼續主流程。

#### 1. 創建 JSON 代碼生成節點

新建 Workflow 應用，並添加 LLM 節點和代碼節點。通過 Prompt 讓 LLM 根據指令生成正確或錯誤格式的 JSON 內容，然後通過 A 代碼節點驗證。

**LLM** 節點內的 **Prompt 參考**：
```
You are a teaching assistant. According to the user's requirements, you only output a correct or incorrect sample code in json format.
```

代碼節點中的 JSON 驗證代碼：
```
def main(json_str: str) -> dict:
    obj = json.loads(json_str)
    return {'result': obj}
```

#### 2. 為 A 代碼節點添加異常處理機制
A 代碼節點是驗證 JSON 內容的節點，如果接收到的 JSON 內容格式錯誤，需要通過異常處理機制運行備用路徑，讓下一個 LLM 節點修覆錯誤內容並重新驗證 JSON 從而繼續主流程。在 A 代碼節點的“異常處理”選項卡中，選擇“異常分支”並新建 LLM 節點。

[Arcade](https://app.arcade.software/share/rKbAJ2tYTbTA9JXhMMun)

#### 3. 修正 A 代碼節點輸出的異常內容
在新的 LLM 節點中，填寫 Prompt 並通過變量引用 A 代碼節點的異常輸出內容，並進行修覆。添加 B 代碼節點對 JSON 內容進行二次驗證。

#### 4. 結束
添加變量聚合節點，匯總正確和錯誤分支的處理結果並輸出至結束節點內，完成整體流程。
![修正A代碼節點輸出的異常內容釋例](/工作流/異常處理/images/修正A代碼節點輸出的異常內容釋例.png)

## 狀態描述
狀態指的是節點狀態與流程狀態。清晰的狀態說明有助於開發者判斷當前工作流應用的運行現狀，協助進行問題排查，快速了解信息並做出對應決策。引入異常處理機制後，節點狀態和流程存在以下狀態：

### 節點狀態

- 成功

    節點正常執行，並正確輸出信息。

- 失敗

    未啟用異常處理，節點執行失敗，輸出報錯信息。

- 異常

    在異常處理機制中啟用了默認值或異常分支選項。節點執行時遇到了錯誤，但啟用異常機制應對錯誤。

### 工作流狀態
- 成功

    流程中的所有節點正常執行，結束節點能夠正確輸出信息，狀態被標記為 Success。

- 失敗

    因出現節點異常，整體流程被中斷，狀態被標記為 Failed。

- 局部成功

    節點出現異常，但啟用了異常處理機制，整體流程最終運行正常。狀態將會被標記為 Partial success。

常見問題
#### 1. 啟用異常處理機制前後的區別是什麽？
<<<<<<< HEAD <<<<<<< HEAD

#### 沒有錯誤處理機制時：
- **節點錯誤中斷流程**：當 LLM 調用失敗、網絡出現問題或工具出錯時，整個工作流程會立即中斷，應用開發者需要手動查找並修覆錯誤後重新運行流程。

- **缺乏靈活性**：開發者無法對不同錯誤類型或節點定義特定的處理邏輯。例如，無法在錯誤發生時繼續後續流程或選擇替代路徑。

- **手動添加冗余節點**：避免錯誤影響全局需要額外設計大量節點來捕獲和處理錯誤，增加了工作流程的覆雜性和開發成本。

- **日志信息有限**：錯誤日志通常簡單或不足，無法快速診斷問題。

#### 啟用異常處理機制後:

- **流程不中斷**：即使某個節點發生錯誤，工作流程可以根據用戶定義的規則繼續運行，減少因單點失敗導致的全局影響。

- **靈活自定義錯誤處理**：應用開發者可以為每個節點指定錯誤處理策略，如繼續流程、記錄日志，或切換到替代路徑。

- **簡化工作流程設計**：通用錯誤處理器減少了用戶手動設計冗余節點的需求，流程更清晰簡潔。

- **詳細錯誤日志支持**：提供錯誤信息的自定義編排機制，便於開發者快速排查問題和優化流程。

#### 2. 如何調試替代路徑的執行情況？
你可以通過工作流程的運行日志檢查條件判斷和路徑選擇情況。異常分支的運行路線以黃色高亮顯示，幫助開發者驗證替代路徑是否按預期執行。