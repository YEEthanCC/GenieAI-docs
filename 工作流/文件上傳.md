# 文件上傳

相較於聊天文本，文檔文件能夠承載大量的信息，例如學術報告、法律合同。受限於 LLM 自身僅能夠支持文件或圖片，難以獲取文件內更加豐富的上下文信息，應用的使用者不得不手動覆制粘貼大量信息與 LLM 對話，增加了許多不必要的使用成本。


文件上傳功能允許將文件以 File variables 的形式在工作流應用中上傳、解析、引用、和下載。開發者現可輕松構建能理解和處理圖片、音頻、視頻的覆雜工作。

## 應用場景
1. **文檔分析**: 上傳學術研究報告文件，LLM 可以快速總結要點，根據文件內容回答相關問題。

2. **代碼審查**: 開發者上傳代碼文件，獲得優化建議與 bug 檢測。

3. **學習輔導**: 學生上傳作業或學習資料，獲得個性化的解釋和指導。

4. **法律援助**: 上傳完整的合同文本，由 LLM 協助審查條款，指出潛在風險。

## 文件上傳與知識庫的區別
文件上傳和知識庫都是為 LLM 提供額外上下文信息的方式，但它們在使用場景和功能上有明顯區別：

1. 信息來源：

    - 文件上傳：允許終端用戶在對話過程中動態上傳文件，提供即時的、個性化的上下文信息。

    - 知識庫：由應用開發者預先設置和管理，包含相對固定的信息集合。

2. 使用靈活性：

    - 文件上傳：更加靈活，用戶可以根據具體需求上傳不同類型的文件。

    - 知識庫：內容相對固定，但可以被多個會話重覆利用。

3. 信息處理：

    - 文件上傳：需要通過文檔提取器或其他工具將文件內容轉換為 LLM 可理解的文本。

    - 知識庫：通常已經過預處理和索引，可以直接進行檢索。

3. 應用場景：

    - 文件上傳：適用於需要處理用戶特定文檔的場景，如文檔分析、個性化學習輔導等。

    - 知識庫：適用於需要訪問大量預設信息的場景，如客戶服務、產品咨詢等。

5. 數據持久性：

    - 文件上傳：通常為臨時使用，不會長期存儲在系統中。

    - 知識庫：作為應用的一部分長期存在，可以持續更新和維護。

## 快速開始：搭建具備文件上傳功能的工作流應用
AgentBuilder 支持在 [ChatFlow](https://docs.dify.ai/zh-hans/guides/workflow/key-concept#chatflow-he-workflow) 和 [WorkFlow](https://docs.dify.ai/zh-hans/guides/workflow/key-concept#chatflow-he-workflow) 類型應用中上傳文件，並通過[變量](https://docs.dify.ai/zh-hans/guides/workflow/variables)交由 LLM 處理。應用開發者可以參考以下方法為應用開啟文件上傳功能：

- 在 Workflow 應用中：

    - 在 ["開始節點"](https://docs.dify.ai/zh-hans/guides/workflow/node/start) 添加文件變量

- 在 ChatFlow 應用中：

    - 在 ["附加功能"](https://docs.dify.ai/zh-hans/guides/workflow/additional-features) 中開啟文件上傳，允許在聊天窗中直接上傳文件

    - 在 ["開始節點"](https://docs.dify.ai/zh-hans/guides/workflow/node/start) 添加文件變量

    - 注意：這兩種方法可以同時配置，它們是彼此獨立的。附加功能中的文件上傳設置（包括上傳方式和數量限制）不會影響開始節點中的文件變量。例如只想通過開始節點創建文件變量，則無需開啟附加功能中的文件上傳功能。

這兩種方法為應用提供了靈活的文件上傳選項，以滿足不同場景的需求。

## File Types
file variables 和 array[file] variables 支持以下文件類型與格式：
|文件類型|支持格式|
|-------|-------|
|文檔|TXT, MARKDOWN, PDF, HTML, XLSX, XLS, DOCX, CSV, EML, MSG, PPTX, PPT, XML, EPUB.|
|圖片|JPG, JPEG, PNG, GIF, WEBP, SVG.|
|音頻|MP3, M4A, WAV, WEBM, AMR.|
|視頻|MP4, MOV, MPEG, MPGA.|
|其他|自定義後綴名支持|

## 方法一：使用具備識別文件的 LLM
部分 LLMs（例如 [Claude 3.5 Sonnet](https://docs.anthropic.com/en/docs/build-with-claude/pdf-support)）已支持直接處理並分析文件內容，因此 LLM 節點的提示詞已允許輸入文件變量。

*為了避免潛在異常，應用開發者在使用該文件變量前需前往 LLM 官網確認 LLM 支持何種文件類型。*

1. 點擊創建 Chatflow / Workflow 應用。

2. 添加 LLM 節點，選擇具備文件分析能力的 LLM。

3. 在開始節點添加文件變量

4. 在 LLM 的系統提示詞內輸入文件變量。

5. 完成創建。

## 方法二：在應用聊天框中開啟文件上傳（僅適用於 Chatflow）
1. 點擊 Chatflow 應用右上角的 “功能” 按鈕即可為應用添加更多功能。
開啟此功能後，應用使用者可以在應用對話的過程中隨時上傳並更新文件。最多支持同時上傳 10 個文件，每個文件的大小上限為 15MB。
![文件上傳功能](/工作流/images/文件上傳功能.png)
*文件上傳功能*

開啟該功能並不意味著賦予 LLM 直接讀取文件的能力，還需要配備[文檔提取器](https://docs.dify.ai/zh-hans/guides/workflow/node/doc-extractor)將文檔解析為文本供 LLM 理解。

- 對於音頻文件，可以使用 ```gpt-4o-audio-preview``` 等支持多模態輸入的模型直接處理音頻，無需額外的提取器。

- 對於視頻和其他文件類型，暫無對應的提取器，需要應用開發者接入[外部工具](https://docs.dify.ai/zh-hans/guides/tools/advanced-tool-integration)進行處理

2. 添加[文檔提取器](https://docs.dify.ai/zh-hans/guides/workflow/node/doc-extractor)節點，在輸入變量中選中 sys.files 變量。

3. 添加 LLM 節點，在系統提示詞中選中文檔提取器節點的輸出變量。

4. 在末尾添加 “直接回覆” 節點，填寫 LLM 節點的輸出變量。
![文檔提取器](/工作流/images/文檔提取器.png)

開啟後，用戶可以在對話框中上傳文件並進行對話。但通過此方式， LLM 應用並不具備記憶文件內容的能力，每次對話時需要上傳文件。

![文檔提取器app](/工作流/images/文檔提取器app.png)

若希望 LLM 能夠在對話中記憶文件內容，請參考下文。

## 方法三：通過添加文件變量開啟文件上傳功能
1. 在“開始”節點添加文件變量
在應用的[“開始”](https://docs.dify.ai/zh-hans/guides/workflow/node/start)節點內添加輸入字段，選擇 **“單文件”** 或 **“文件列表”** 字段類型的變量。
[文件上傳功能影片](https://slickwid-public.s3.amazonaws.com/walkthrough/6772ae35d65f37064a5d28d3)


- 單文件

    僅允許應用使用者上傳單個文件。

- 文件列表

    允許應用使用者單次批量上傳多個文件。

*為了便於操作，將使用單文件變量作為示例。*

## 文件解析

文件變量的使用方式主要分為兩種：

1. 使用工具節點轉換文件內容：

    - 對於文檔類型的文件，可以使用"文檔提取器"節點將文件內容轉換為文本形式。

    - 這種方法適用於需要將文件內容解析為模型可理解的格式（如 string、array[string] 等）的情況。

2. 直接在 LLM 節點中使用文件變量：

    - 對於某些特定類型的文件（如圖片），可以在 LLM 節點中直接使用文件變量。

    - 例如，對於圖片類型的 file variables，可以在 LLM 節點中啟用 vision 功能，然後在變量選擇器中直接引用對應的文件變量。

選擇哪種方式取決於文件類型和你的具體需求。接下來，我們將詳細介紹這兩種方法的具體操作步驟。

## 添加文檔提取器節點
上傳文件後將存儲至單文件變量內，LLM 暫不支持直接讀取變量中的文件。因此需要先添加 [“文檔提取器”](https://docs.dify.ai/zh-hans/guides/workflow/node/doc-extractor)節點，從已上傳的文檔文件內提取內容並發送至 LLM 節點完成信息處理。

將“開始”節點內的文件變量作為 **“文檔提取器”** 節點的輸入變量。

![添加輸入變量](/工作流/images/添加輸入變量.png)
*添加輸入變量*

將“文檔提取器”節點的輸出變量填寫至 LLM 節點的系統提示詞內。

![粘貼系統提示詞](/工作流/images/粘貼系統提示詞.png)
*粘貼系統提示詞*

完成上述設置後，應用的使用者可以在 WebApp 內粘貼文件 URL 或上傳本地文件，然後就文檔內容與 LLM 展開互動。應用使用者可以在對話過程中隨時替換文件，LLM 將獲取最新的文件內容。

![上傳文件對話](/工作流/images/上傳文件對話.png)
*上傳文件對話*

## 在 LLM 節點中引用文件變量

對於某些特定類型的文件（如圖片），可以在 LLM 節點中直接使用文件變量。這種方法特別適用於需要視覺分析的場景。以下是具體步驟：

1. 在 LLM 節點中，啟用 vision 功能。這允許模型處理圖像輸入（模型需要支持 vision）。

2. 在 LLM 節點的變量選擇器中，直接引用之前創建的文件變量如果是通過附加功能開啟的文件上傳，則選擇 ```sys.files``` 變量。

3. 在系統提示詞中，指導模型如何處理圖像輸入。例如，你可以要求模型描述圖像內容或回答關於圖像的問題。

下面是一個示例配置：

![在LLM節點中直接使用文件變量](/工作流/images/在LLM節點中直接使用文件變量.png)
*在LLM節點中直接使用文件變量*

需要注意的是，直接在 LLM 節點中使用文件變量時，我們需要確保文件變量僅包含圖片文件，否則可能會導致錯誤。如果用戶可能上傳不同類型的文件，我們需要使用列表操作節點過濾不同類型的文件。

## 文件下載

將文件變量放置到 answer 節點或者 end 節點中，當應用運行到該節點都時候將會在會話框中提供文件下載卡片。點擊卡片即可下載文件。

![在LLM節點中直接使用文件變量](/工作流/images/文件下載.png)

## 進階使用

若希望應用能夠支持上傳多種文件，例如允許用戶同時上傳文檔文件、圖片和音視頻文件，此時需要在 “開始節點” 中添加 “文件列表” 變量，並通過“列表操作”節點針對不同的文件類型進行處理。詳細說明請參考[列表操作](https://docs.dify.ai/zh-hans/guides/workflow/node/list-operator)節點。

![文件列表](/工作流/images/文件列表.png)
如需查看更多使用案例，請參考：[動手實驗室 - 使用文件上傳搭建文章理解助手](https://docs.dify.ai/zh-hans/workshop/intermediate/article-reader)