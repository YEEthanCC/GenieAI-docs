# 建立知識庫&上傳文檔
## 1 創建知識庫
在AgentBuilder 主導覽列中點選知識庫，在該頁面你可以看到已有的知識庫。你可以點選建立知識庫進入建立精靈：
創建知識庫

![創建知識庫](/知識庫/images/創建知識庫.png)

- 如果你已經準備好了文件，可以從上傳文件開始;
- 如果你還沒準備好文檔，可以先建立一個空資料集;

![上傳文件](/知識庫/images/上傳文件.png)

## 2 上傳文檔
**知識庫內上傳文件的步驟：**
1. 從本地選擇你需要上傳的文檔；
2. 分段與清洗，預覽效果；
3. 選擇及配置索引和檢索策略；
4. 等待分段嵌入；
5. 完成上傳，可以在應用程式中使用了🎉

**上傳文檔的限制：**
- 單一文檔的上傳大小限制為15MB；
- 單次批次上傳檔案數量上限為20 個；
- SaaS 版本的不同訂閱方案限定了批次上傳個數、文件上傳總數、向量儲存；

## 3 分段與清洗
**分段**：大語言模型存在有限的上下文窗口，通常需要將整段文字進行分段處理後，將與用戶問題關聯度最高的幾個段落召回，即分段TopK 召回模式。此外，當使用者問題與文字分段進行語意配對時，適當的分段大小將有助於匹配關聯性最高的文字內容，減少資訊雜訊。

**清洗**：為了確保文字回想的效果，通常需要在將資料傳入模型之前進行清理。例如，如果輸出中存在不需要的字元或空白行，可能會影響問題回應的品質。為了幫助用戶解決這個問題， AgentBuilder 提供了多種清洗方法，可以幫助用戶在將輸出發送到下游應用程式之前進行清理。

分段與清洗支援兩種配置策略

- 自動模式（即將下線）
- 自訂模式

![自動分段與清洗](/知識庫/images/自動分段與清洗.png)

在自訂模式下，使用者可以根據不同的文件格式和場景要求來配置文字的分段和清洗策略。

**分段規則：**
- 兒分段標識符，設定標識符如“\n”，系統將在文字中出現該標識符時分段；
- 分段最大長度，根據分段的文字字元數最大上限來進行分段，超出該長度時將強制分段；
- 分段重疊長度，設定分段間的重疊字元數，建議設定為分段長度的10-25%，有助於保留分段間的語意相
關性，在多分段回想時提高召回效果。

**預處理規則:**
- 替換連續的空格、換行符號和製表符；
- 刪除所有URL 和電子郵件地址；

## 4 ETL 可選配置
在RAG 的生產級應用中，為了獲得更好的資料召回效果，需要對多來源資料進行預處理和清洗，即ETL （extract, transform, load）。為了增強非結構化/半結構化資料的預處理能力，AgentBuilder 支援了可選的ETL 方案：AgentBuilder ETL和Unstructured ETL。  
```Unstructured 能夠有效率地提取並轉換您的資料為乾淨的資料用於後續的步驟。```
AgentBuilder 各版本的ETL 方案選擇：
- SaaS 版不可選，預設使用Unstructured ETL；
- 社群版可選，預設使用AgentBuilder ETL ，可透過環境變數開啟Unstructured ETL；

檔案解析支援格式的差異：
|**AgentBuilder ETL**|**Unstructured ETL**|
|:-----------|:-------------------|
|txt、markdown、md、pdf、html、htm、xlsx、xls、docx、csv|txt、markdown、md、pdf、html、htm、xlsx、xls、docx、csv、eml、msg、pptx、ppt、xml、epub|

## 5 索引方式
你需要選擇文字的**索引方式**來指定資料的匹配方式，索引策略往往與檢索方式相關，你需要根據場景需求來選擇合適的索引方式。

**高品質模式**：將呼叫OpenAI 的嵌入介面進行處理，以在使用者查詢時提供更高的準確度。

**經濟模式**：會使用關鍵字索引方式，降低了準確度但無需花費Token。

**Q&A 模式（僅社群版支援）**： Q&A 分段模式功能，與上述普通的「Q to P」（問題匹配文字段落）匹配模式不同，它是採用「Q to Q」（問題匹配問題）匹配工作，在文件經過分段後，經過總結為每一個分段產生Q&A 匹配對，當使用者提問時，系統會找出與之最相似的問題，然後返回對應的分段作為答案。這種方式更加精確，因為它直接針對用戶問題進行匹配，並且可以更準確地獲取用戶真正需要的資訊。

在知識庫上傳文件時，系統將對文字進行分段，使得使用者的提問（輸入）能配對到相關的文字段落（Q to P），最後輸出結果。

```
問題文本是具有完整語法結構的自然語言，而不是文檔檢索任務中的一些關鍵字，所以Q to Q （問題匹配問題）的模式會令語義和匹配更加清晰，並同時滿足一些高頻和高相似度問題的提問場景。
```

![Q&A分段模式](/知識庫/images/Q&A分段模式.png)

## 6 檢索設定
在高品質索引模式下，AgentBuilder 提供了3 種檢索方案：
- **向量檢索**，透過產生查詢嵌入並查詢與其向量表示最相似的文字分段。
- **向量檢索**，透過產生查詢嵌入並查詢與其向量表示最相似的文字分段。
- **混合檢索**，同時執行全文檢索和向量檢索，並附加重排序步驟，從兩類查詢結果中選擇匹配使用者問題的
最佳結果，需配置Rerank 模型API。

三種檢索方式的具體配置如下:

**向量檢索**

定義：透過產生查詢嵌入並查詢與其向量表示最相似的文字分段。

![向量檢索設定](/知識庫/images/向量檢索設定.png)

TopK：用於篩選與使用者問題相似度最高的文字片段。系統同時會根據選用模型上下文視窗大小動態調整片段數量。系統預設值為3 。數值越高，預期被回想的文字分段數量越多。

Score 閾值：用於設定文字片段篩選的相似度閾值，即：只召回超過設定分數的文字片段。系統預設關閉該設置，即不會對召回的文字片段相似值進行過濾。開啟後預設值為0.5。數值越高，預期被回想的文字數量越少。

Rerank 模型：你可以在“模型供應商”頁面配置Rerank 模型的API 秘鑰之後，在檢索設定中打開“Rerank 模型”，系統會在語義檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設定Rerank 模型後，TopK 和Score 閾值設定僅在Rerank 步驟生效。

**全文檢索** 

定義：索引文件中的所有詞彙，從而允許使用者查詢任意詞彙，並傳回包含這些詞彙的文本片段。

![全文檢索設定](/知識庫/images/全文檢索設定.png)

TopK：用於篩選與使用者問題相似度最高的文字片段。系統同時會根據選用模型上下文視窗大小動態調整片段數量。系統預設值為3 。數值越高，預期被回想的文字分段數量越多。

Score 閾值：用於設定文字片段篩選的相似度閾值，即：只召回超過設定分數的文字片段。系統預設關閉該設置，即不會對召回的文字片段相似值進行過濾。開啟後預設值為0.5。數值越高，預期被回想的文字數量越少。

Rerank 模型：你可以在“模型供應商”頁面配置Rerank 模型的API 秘鑰之後，在檢索設定中開啟“Rerank 模型”，系統會在全文檢索後對已召回的文件結果再一次進行語義重排序，優化排序結果。設定Rerank 模型後，TopK 和Score 閾值設定僅在Rerank 步驟生效。

