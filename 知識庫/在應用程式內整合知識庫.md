# 在應用程式內整合知識庫
## 在應用程式內引用知識庫
知識庫可以作為外部知識提供給大語言模型用於精確回覆使用者問題，你可以在GenieAI 的所有應用程式類型內關聯已建立的知識庫。

1. 進入**工作室-- 建立應用程式--建立聊天助手**
2. 進入**上下文設定**點選**新增**選擇已建立的知識庫
3. 在**上下文設定-- 參數設定**內配置**召回策略**
4. 在**新增功能**內開啟**引用和歸屬**
5. 在**調試與預覽**內輸入與知識庫相關的使用者問題進行調試
6. 調試完成之後**保存並發佈**為AI 知識庫問答類應用

## 關聯知識庫並指定召回模式
如果目前應用的上下文涉及多個知識庫，需要設定召回模式以使得檢索的內容更加精確。進入**上下文-- 參數設定-- 召回設置**，選擇知識庫的召回模式。

**N 選1 召回（Legacy）**
N 選1 召回由Function Call/ReAct 驅動，每一個關聯的知識庫作為工具函數，LLM 會自主選擇與用戶問題最匹配的1 個知識庫來進行查詢，**推理依據為用戶問題與知識庫描述的語意的匹配程度**。

原理圖如下：

![Legacy原理圖](/知識庫/images/Legacy原理圖.png)

舉例：A 應用的脈絡關聯了K1、K2、K3 三個知識庫。使用N 選1 回想策略後，使用者在應用程式內輸入問題後，LLM 會擷取這三個知識庫的描述，以符合某個最適合的知識庫並使用其中的內容進行檢索。

![Legacy例子](/知識庫/images/Legacy例子.png)

雖然此方法無需配置Rerank模型，但此召回策略僅匹配單一知識庫，且匹配的目標知識庫嚴重依賴LLM 對於知識庫描述的理解，檢索符合知識庫時可能會存在不合理的判斷，導致檢索到的結果可能不全面、不準確，從而無法提供高品質的查詢結果。

自9 月後，該策略將會自動替換為**多路召回**，請提前進行修改。

在N 選1 模式下，回想效果主要受三個因素影響：
- **系統推理模型的能力**部分模型對於Function Call/ReAct 的指令遵循程度不穩定
- **知識庫描述是否清晰**描述內容會影響LLM 對使用者問題與相關知識庫的推理
- **知識庫的數量**知識庫過多會影響LLM 的推理精確性，同時可能會超出推理模型的上下文視窗長度。

**提升N 選1 模式推薦效果的方法**：

- 選擇效果更好的系統推理模型，關聯盡量少的知識庫，提供精確的知識庫描述。
- 在知識庫內上傳文件內容時，系統推理模型會自動為知識庫產生摘要描述。為了在該模式下獲得最佳的召回效果，你可以在「知識庫->設定->知識庫描述」 中查看到系統預設建立的摘要描述，並檢查該內容是否可以清晰的概括知識庫的內容。

**多路召回（推薦）**

在多路召回模式下，檢索器會在所有與應用關聯的知識庫中去檢索與使用者問題相關的文字內容，並將多路召回的相關文件結果合併，以下是多路召回模式的技術流程圖：

![多路召回原理圖](/知識庫/images/多路召回原理圖.png)

根據使用者意圖同時檢索所有新增至「上下文」的知識庫，在多個知識庫內查詢相關文字片段，選擇所有和使用者問題相符的內容，最後透過Rerank 策略找到最適合的內容並回答使用者。此方法的檢索原理更為科學。

![多路召回例子](/知識庫/images/多路召回例子.png)

舉例：A 應用的上下文關聯了K1、K2、K3 三個知識庫，當使用者輸入問題後，將在三個知識庫內檢索並彙總多條內容。為確保能找到最匹配的內容，需要透過Rerank 策略來確定與使用者問題最相關的內容，確保結果更加精準與可信。

在實際問答場景中，每個知識庫的內容來源和檢索方式可能都有差異。針對檢索傳回的多條混合內容，Rerank 策略是一個更科學的內容排序機制。它可以幫助確認候選內容清單與使用者問題的匹配度，改善多個知識間排序的結果以找到最匹配的內容，並提高回答品質和使用者體驗。

考慮到Rerank 的使用成本和業務需求，多路召回模式提供了以下兩種Rerank 設定：

**權重設定**

此設定無需配置外部Rerank 模型，重新排序內容**無需額外花費**。可以透過調整語意或關鍵字的權重比例條，選擇最適合的內容匹配策略。

- **語意值為 1**

    僅啟用語意檢索模式。借助Embedding 模型，即便知識庫中沒有出現查詢中的確切詞彙，也能透過計算向量距離的方式提高搜尋的深度，傳回正確內容。此外，當需要處理多語言內容時，語意檢索能夠捕捉不同語言之間的意義轉換，提供更精確的跨語言搜尋結果。

    語意檢索指的是比對使用者問題與知識庫內容中的向量距離。距離越近，匹配的機率越大。
- **關鍵字值為 1**

    僅啟用關鍵字檢索模式。透過使用者輸入的資訊文字在知識庫全文匹配，適用於使用者知道確切的資訊或術語的場景。此方法所消耗的計算資源較低，適合在大量文件的知識庫內快速檢索。

- **自訂關鍵字和語意權重**

    除了僅啟用語意檢索或關鍵字檢索模式，我們還提供了靈活的自訂權重設定。你可以透過不斷調試二者的權重，找到符合業務場景的最佳權重比例。

**Rerank 模型**

Rerank 模型是一種外部評分系統，它會計算使用者問題與給定的每個候選文件之間的相關性分數，從而改善語義排序的結果，並按相關性傳回從高到低排序的文件清單。

雖然此方法會產生一定的額外花費，但是更擅長處理知識庫內容來源複雜的情況，例如混合了語義查詢和關鍵字匹配的內容，或返回內容存在多語言的情況。

GenieAI 目前支援多個Rerank 模型，進入「模型供應商」 頁填入Rerank 模型（例如Cohere、Jina 等模型）的API Key。

![配置Rerank模型](/知識庫/images/配置Rerank模型.png)

**可調參數**
- **TopK**

    用於篩選與使用者問題相似度最高的文字片段。系統同時會根據選用模型上下文視窗大小，動態調整分段數量。數值越高，預期被回想的文字分段數量越多。
- **Score 閾值**

    用於設定文字片段篩選的相似度閾值。向量檢索的相似度分數需要超過設定的分數後才會被召回，數值越高，預期被召回的文字數量越少。

多路召回模式在多知識庫檢索時能夠獲得品質更高的召回效果，因此更**建議將召回模式設定為多路召回**。

## 常見問題
1. 如何選擇多路召回中的Rerank 設定？

    如果使用者知道確切的資訊或術語，可以透過關鍵字檢索精確發揮匹配結果，那麼請將「權重設定」 中的**關鍵字設為1**。

    如果知識庫內並未出現確切詞彙，或有跨語言查詢的情況，那麼建議使用「權重設定」 中的**語意設定為1**。

    如果業務人員對於使用者的實際提問場景比較熟悉，想要主動調整語意或關鍵字的比值，那麼建議自行調整「權重設定」 裡的比值。

    如果知識庫內容較為複雜，無法透過語意或關鍵字等簡單條件進行匹配，同時要求較為精準的回答，願意支付額外的費用，那麼建議使用**Rerank 模型**進行內容檢索。

2. 為什麼會出現找不到「權重設定」 或要求必須配置Rerank 模型等情況，該如何處理？

    以下是知識庫檢索方式對多路召回的影響：
    
|**知識庫索引模式**|**知識庫檢索設定**|**Embedding 模型**|**多路召回的頁面提示**|**原因**|
|:----------------|:---------------|:-----------------|:--------------------|:------|
|全部經濟型|倒排索引|無|無法使用權重配置，允許是否啟用Rerank|模型|
|全部高品質型|1. 所有知識庫都使用了向量檢索|相同的Embedding 模型|預設選用"權重設定"，語意數值為 1|Rerank 設定與知識庫檢索設定相符|
|全部高品質型|2. 所有知識庫都使用了全文檢索|相同的Embedding 模型|預設選用"權重設定"，關鍵字數值為 1|Rerank 設定與知識庫檢索設定相符|
|全部高品質型|3. 二者混合|相同的Embedding 模型|預設使用"權重設定" 的自訂配置，比例為語意:關鍵字= 0.7:0.3|知識庫內的內容來源混合了語義和關鍵字，讓業務|人員可以自訂權重設置|
|既有經濟型也有高品質|使用了不同的檢索設置|不同的Embedding 模型|需要啟用Rerank 模型|內容來源較為複雜，建議啟用Rerank 模型確保內容回傳品質|
|高品質|使用了相同/不同的檢索設置|不同的Embedding 模型|需要啟用Rerank 模型|該情況的內容來源格式並不統一，無法依照相同的標準進行排序。為了確保內容檢索的準確度，要求配置Rerank 模型以增加內容檢索的準確性。|

3. **引用多個知識庫時，無法調整“權重設定”，提示錯誤該如何處理？**

    出現此問題是因為上下文內所引用的多個知識庫內所使用的嵌入模型（Embedding）不一致，為避免檢索內容衝突而出現此提示。建議設定在「模型供應商」內設定並啟用Rerank 模型，或統一知識庫的檢索設定。

4. **為什麼在多路召回模式下找不到「權重設定」選項，只能看到Rerank 模型？**

    請檢查你的知識庫是否使用了「經濟」型索引模式。如果是，那麼將其切換為“高品質”索引模式
